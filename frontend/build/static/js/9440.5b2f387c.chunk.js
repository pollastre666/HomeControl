"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[9440],{9440:(e,a,r)=>{r.r(a),r.d(a,{default:()=>p});var i=r(9950),t=r(3816),d=r(5054),s=r(5082),n=r(6220),o=r(1123),l=r(6174),c=r(4414);const m={hidden:{opacity:0,y:50},visible:e=>({opacity:1,y:0,transition:{delay:.2*e,duration:.6,ease:"easeOut"}})},g={hidden:{opacity:0,scale:.8},visible:{opacity:1,scale:1,transition:{duration:.5,ease:"easeOut"}}},u=(e,a,r)=>{(0,i.useEffect)((()=>{if(!r||0===e.length||0===a.length)return;const i=new Map,t=()=>{const r=new Date,t=r.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",timeZone:"UTC"}),d=r.getDay();e.forEach((e=>{if(!e.active)return;("Cada d\xeda"===e.days||"Lunes - Viernes"===e.days&&d>=1&&d<=5||"S\xe1bado - Domingo"===e.days&&(0===d||6===d))&&e.devices.forEach((d=>{const o=((e,a)=>{const[r,i]=e.split(":").map(Number),[t,d]=a.split(":").map(Number),s=60*r+i,n=60*t+d;return Math.abs(s-n)<=1})(d.time,t),c=`${e.id}-${d.deviceId}`,m=i.get(c)||0;if(o&&Date.now()-m<3e5)return;if(d.time!==t)return void(o&&(l.oR.warn(`Horario "${e.name}" no ejecutado: hora no coincide (${d.time} vs ${t})`),i.set(c,Date.now())));const g=a.find((e=>e.id===d.deviceId));if(!g)return void(o&&(l.oR.warn(`Horario "${e.name}" no ejecutado: dispositivo no encontrado`),i.set(c,Date.now())));const u=e.lastTriggered instanceof n.Dc?e.lastTriggered.toDate().getTime():e.lastTriggered||0;if(Date.now()-u<3e4)o&&(l.oR.warn(`Horario "${e.name}" no ejecutado: ejecutado recientemente`),i.set(c,Date.now()));else{if("once"!==e.repeat&&e.repeatInterval){const a=60*e.repeatInterval*1e3;if(u&&Date.now()-u<a)return void(o&&(l.oR.warn(`Horario "${e.name}" no ejecutado: intervalo de repetici\xf3n no cumplido`),i.set(c,Date.now())))}(0,n.BN)((0,n.H9)(s.db,"schedules",e.id),{...e,lastTriggered:n.Dc.fromDate(r)},{merge:!0}).then((()=>l.oR.info(`Ejecutando "${e.name}": Encendiendo ${g.name} a las ${d.time}`))).catch((()=>l.oR.error("Error al ejecutar el horario")))}}))}))},d=setInterval(t,15e3);return t(),()=>clearInterval(d)}),[e,a,r])},h=(e,a)=>{switch(a.type){case"SET_SCHEDULES":return a.payload;case"ADD_SCHEDULE":return[...e,a.payload];case"UPDATE_SCHEDULE":return e.map((e=>e.id===a.payload.id?a.payload:e));case"DELETE_SCHEDULE":return e.filter((e=>e.id!==a.payload));default:return e}},v=i.memo((e=>{let{schedule:a,devices:r,handleToggleActive:i,openModal:d,handleDelete:s,index:o}=e;return(0,c.jsxs)(t.P.div,{className:"bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-amber-200/20",variants:m,custom:o,initial:"hidden",whileInView:"visible",viewport:{once:!0},whileHover:{scale:1.05,boxShadow:"0 12px 24px rgba(0, 0, 0, 0.1)"},"aria-label":`Horario: ${a.name}`,children:[(0,c.jsx)("h3",{className:"text-lg font-semibold text-amber-600 dark:text-amber-400",children:a.name}),(0,c.jsxs)("div",{className:"space-y-2 text-sm text-gray-600 dark:text-gray-400",children:[(0,c.jsxs)("p",{children:["Dispositivos: ",a.devices.map((e=>{var a;return(null===(a=r.find((a=>a.id===e.deviceId)))||void 0===a?void 0:a.name)||"Desconocido"})).join(", ")]}),(0,c.jsxs)("p",{children:["D\xedas: ",a.days]}),(0,c.jsxs)("p",{children:["Repetici\xf3n: ","once"===a.repeat?"Una vez":"daily"===a.repeat?"Diario":"Semanal"]}),(0,c.jsxs)("p",{children:["\xdaltima ejecuci\xf3n: ",a.lastTriggered?new Date(a.lastTriggered instanceof n.Dc?a.lastTriggered.toDate():a.lastTriggered).toLocaleString():"Nunca"]})]}),(0,c.jsxs)("div",{className:"flex gap-2 mt-4",children:[(0,c.jsx)("button",{onClick:()=>i(a.id),className:(a.active?"bg-green-500 hover:bg-green-600":"bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500")+" px-3 py-2 rounded-lg text-white",children:a.active?"Activo":"Inactivo"}),(0,c.jsx)("button",{onClick:()=>d(a),className:"px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600",children:"Editar"}),(0,c.jsx)("button",{onClick:()=>s(a.id),className:"px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Eliminar"})]})]})})),b=i.memo((e=>{let{isOpen:a,onConfirm:r,onCancel:i,message:d}=e;return a&&(0,c.jsx)(t.P.div,{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.4},children:(0,c.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm",children:[(0,c.jsx)("p",{className:"text-gray-700 dark:text-gray-200 mb-4",children:d}),(0,c.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,c.jsx)("button",{onClick:i,className:"px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500",children:"Cancelar"}),(0,c.jsx)("button",{onClick:r,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Confirmar"})]})]})})})),x=i.memo((e=>{let{isOpen:a,closeModal:r,formData:i,setFormData:d,devices:s,handleSave:n,isSaving:o,error:m}=e;return a&&(0,c.jsx)(t.P.div,{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",variants:g,initial:"hidden",animate:"visible",exit:"hidden",children:(0,c.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-lg border border-amber-200/20",children:[(0,c.jsx)("h2",{className:"text-xl font-bold text-amber-600 dark:text-amber-400 mb-4",children:i.id?"Editar Horario":"Nuevo Horario"}),m&&(0,c.jsx)("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded mb-4",children:m}),(0,c.jsxs)("div",{className:"space-y-4",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200",htmlFor:"name",children:"Nombre"}),(0,c.jsx)("input",{id:"name",value:i.name,onChange:e=>d({...i,name:e.target.value}),className:"w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 p-3",required:!0,"aria-required":"true"})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200",htmlFor:"days",children:"D\xedas"}),(0,c.jsxs)("select",{id:"days",value:i.days,onChange:e=>d({...i,days:e.target.value}),className:"w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 p-3",children:[(0,c.jsx)("option",{value:"Cada d\xeda",children:"Cada d\xeda"}),(0,c.jsx)("option",{value:"Lunes - Viernes",children:"Lunes - Viernes"}),(0,c.jsx)("option",{value:"S\xe1bado - Domingo",children:"S\xe1bado - Domingo"})]})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200",children:"Repetici\xf3n"}),(0,c.jsx)("div",{className:"flex gap-2",children:["once","daily","weekly"].map((e=>(0,c.jsx)("button",{onClick:()=>d({...i,repeat:e}),className:(i.repeat===e?"bg-amber-500 text-white hover:bg-amber-600":"bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-amber-600 hover:text-white")+" px-3 py-2 rounded-lg",children:"once"===e?"Una vez":"daily"===e?"Diario":"Semanal"},e)))})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200",children:"Dispositivos"}),i.devices.map(((e,a)=>(0,c.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,c.jsxs)("select",{value:e.deviceId,onChange:e=>d((r=>({...r,devices:r.devices.map(((r,i)=>i===a?{...r,deviceId:e.target.value}:r))}))),className:"w-1/3 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 p-3","aria-label":"Seleccionar dispositivo",children:[(0,c.jsx)("option",{value:"",children:"Selecciona"}),s.map((e=>(0,c.jsx)("option",{value:e.id,children:e.name},e.id)))]}),(0,c.jsx)("input",{type:"time",value:e.time||"",onChange:e=>d((r=>({...r,devices:r.devices.map(((r,i)=>i===a?{...r,time:e.target.value}:r))}))),className:"w-1/2 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 p-3","aria-label":"Hora de activaci\xf3n"}),(0,c.jsx)("button",{onClick:()=>d((e=>({...e,devices:e.devices.filter(((e,r)=>r!==a))}))),className:"text-red-600 hover:text-red-800","aria-label":"Eliminar dispositivo",children:"\u2715"})]},a))),(0,c.jsx)("button",{onClick:()=>d((e=>{var a;return{...e,devices:[...e.devices,{deviceId:(null===(a=s[0])||void 0===a?void 0:a.id)||"",time:"00:00"}]}})),className:"mt-2 text-amber-600 hover:text-amber-800 underline",children:"+ A\xf1adir dispositivo"})]})]}),(0,c.jsxs)("div",{className:"flex justify-end gap-2 mt-6",children:[(0,c.jsx)("button",{onClick:r,className:"px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500",children:"Cancelar"}),(0,c.jsx)("button",{onClick:()=>{i.devices.every((e=>e.deviceId&&e.time))?n():l.oR.error("Corrige los errores en los dispositivos")},className:"px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600",disabled:o,children:o?"Guardando...":"Guardar"})]})]})})})),p=()=>{const{user:e}=(0,d.A)(),[a,r]=(0,i.useReducer)(h,[]),[m,g]=(0,i.useState)([]),[p,y]=(0,i.useState)(!1),[j,f]=(0,i.useState)({name:"",devices:[],days:"Cada d\xeda",active:!0,repeat:"once"}),[k,w]=(0,i.useState)(!0),[D,N]=(0,i.useState)(!1),[E,C]=(0,i.useState)(null),[S,H]=(0,i.useState)({isOpen:!1,scheduleId:null});(0,i.useEffect)((()=>{if(!e)return C("Inicia sesi\xf3n para ver los horarios."),w(!1),void l.oR.error("Inicia sesi\xf3n para continuar");w(!0),Promise.all([(0,n.GG)((0,n.rJ)(s.db,"devices")).then((e=>{const a=e.docs.map((e=>e.id));return["luz_1","enchufe_1"].filter((e=>a.includes(e)||(0,n.BN)((0,n.H9)(s.db,"devices",e),{id:e,name:"luz_1"===e?"Luz Sala":"Enchufe 1"})))})),(0,n.GG)((0,n.rJ)(s.db,"schedules")).then((a=>a.docs.map((e=>({id:e.id,...e.data()}))).filter((a=>a.owner===e.uid))))]).then((e=>{let[a,i]=e;g(a.map((e=>({id:e,name:"luz_1"===e?"Luz Sala":"Enchufe 1"})))),r({type:"SET_SCHEDULES",payload:i}),w(!1)})).catch((()=>{C("Error al cargar los datos."),l.oR.error("Error al cargar los datos"),w(!1)}))}),[e]),u(a,m,e);const I=(0,i.useCallback)((function(){let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e&&0!==m.length?(f(r||{name:`Horario ${a.length+1}`,devices:[],days:"Cada d\xeda",active:!0,repeat:"once"}),y(!0)):l.oR.error(e?"No hay dispositivos disponibles":"Inicia sesi\xf3n")}),[e,m,a]),T=(0,i.useCallback)((()=>{y(!1),C(null)}),[]),R=(0,i.useCallback)((async()=>{if(!j.name.trim()||0===j.devices.length)return C(j.name.trim()?"A\xf1ade al menos un dispositivo":"El nombre es obligatorio"),void l.oR.error(E);N(!0);try{const a=j.id||`schedule-${Date.now()}`,i={owner:e.uid,name:j.name.trim(),devices:j.devices,days:j.days,active:j.active,repeat:j.repeat,createdAt:j.createdAt||n.Dc.fromDate(new Date),lastTriggered:j.lastTriggered||null};await(0,n.BN)((0,n.H9)(s.db,"schedules",a),i),r({type:j.id?"UPDATE_SCHEDULE":"ADD_SCHEDULE",payload:{id:a,...i}}),l.oR.success("Horario guardado con \xe9xito"),T()}catch{C("Error al guardar el horario"),l.oR.error("Error al guardar el horario")}finally{N(!1)}}),[e,j,T]),L=(0,i.useCallback)((a=>{e?H({isOpen:!0,scheduleId:a}):l.oR.error("Inicia sesi\xf3n")}),[e]),U=(0,i.useCallback)((async()=>{try{await(0,n.kd)((0,n.H9)(s.db,"schedules",S.scheduleId)),r({type:"DELETE_SCHEDULE",payload:S.scheduleId}),l.oR.success("Horario eliminado")}catch{l.oR.error("Error al eliminar")}H({isOpen:!1,scheduleId:null})}),[S]),A=(0,i.useCallback)((()=>{H({isOpen:!1,scheduleId:null})}),[]),$=(0,i.useCallback)((async i=>{if(!e)return void l.oR.error("Inicia sesi\xf3n");const t=a.find((e=>e.id===i)),d={...t,active:!t.active};await(0,n.BN)((0,n.H9)(s.db,"schedules",i),d),r({type:"UPDATE_SCHEDULE",payload:d}),l.oR.success("Horario "+(d.active?"activado":"desactivado"))}),[e,a]);return k?(0,c.jsx)(o.A,{children:(0,c.jsx)("div",{className:"text-center text-amber-600 text-lg",children:"Cargando..."})}):(0,c.jsx)(o.A,{children:(0,c.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20",children:[(0,c.jsx)(t.P.h1,{className:"text-3xl sm:text-4xl font-extrabold text-amber-600 dark:text-amber-400 mb-12 tracking-tight",initial:{opacity:0,y:60},whileInView:{opacity:1,y:0},viewport:{once:!0},transition:{duration:.8,ease:"easeOut"},children:"Gesti\xf3n de Horarios"}),E&&(0,c.jsx)("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded mb-6",children:E}),(0,c.jsx)(t.P.button,{onClick:()=>I(),className:"px-4 py-2 bg-amber-500 text-white rounded-lg mb-6 hover:bg-amber-600",whileHover:{scale:1.05},whileTap:{scale:.95},children:"+ Nuevo Horario"}),(0,c.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8",children:a.map(((e,a)=>(0,c.jsx)(v,{schedule:e,devices:m,handleToggleActive:$,openModal:I,handleDelete:L,index:a},e.id)))}),(0,c.jsx)(x,{isOpen:p,closeModal:T,formData:j,setFormData:f,devices:m,handleSave:R,isSaving:D,error:E}),(0,c.jsx)(b,{isOpen:S.isOpen,onConfirm:U,onCancel:A,message:"\xbfEliminar horario?"})]})})}}}]);